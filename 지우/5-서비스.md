# 5μ¥: μ„λΉ„μ¤: ν΄λΌμ΄μ–ΈνΈκ°€ νλ“λ¥Ό κ²€μƒ‰ν•κ³  ν†µμ‹ μ„ κ°€λ¥ν•κ² ν•¨

## Background

λ€λ¶€λ¶„ μ• ν”λ¦¬μΌ€μ΄μ…μ€ μ™Έλ¶€μ™€ ν†µμ‹ ν•λ”λ°, λ§μ΄ν¬λ΅μ„λΉ„μ¤μ κ²½μ° νλ“λ” λ€κ° ν΄λ¬μ¤ν„° λ‚΄λ¶€μ λ‹¤λ¥Έ νλ“λ‚ ν΄λ¬μ¤ν„° μ™Έλ¶€μ ν΄λΌμ΄μ–ΈνΈμ—μ„ μ¤λ” HTTP μ”μ²­μ— μ‘λ‹µν•λ‹¤.

#### νλ“μ— μ§μ ‘ μ ‘κ·Όν•  μ μ—†λ” 3κ°€μ§€ μ΄μ 

- νλ“λ” μΌμ‹μ 
- νλ“μ IPλ” νλ“ μ‹μ‘ μ§μ „μ— ν• λ‹Ήλλ―€λ΅ ν΄λΌμ΄μ–ΈνΈκ°€ λ―Έλ¦¬ μ• μ μ—†μ
- μ—¬λ¬ νλ“κ°€ λ‹¨μΌ IP μ£Όμ†λ΅ μ ‘κ·Όν•  μ μμ–΄μ•Ό ν•¨

β‡’ μ΄ λ¬Έμ λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ μ„λΉ„μ¤ λ¦¬μ†μ¤λ¥Ό ν™μ©ν•λ‹¤.

## 5.1 μ„λΉ„μ¤

> _λ™μΌ μ„λΉ„μ¤λ¥Ό μ κ³µν•λ” νλ“ κ·Έλ£Ήμ— μ§€μ†μ μΈ λ‹¨μΌ μ ‘μ μ„ λ§λ“¤κΈ° μ„ν•΄ μ‚¬μ©ν•λ” λ¦¬μ†μ¤
> β‡’ νλ“μ— μ•μ •μ μΈ IP μ£Όμ†μ™€ ν¬νΈλ¥Ό ν• λ‹Ή_

- μ„λΉ„μ¤λ” ν•λ‚ μ΄μƒμ νλ“λ¥Ό μ§€μ› κ°€λ¥
- μ„λΉ„μ¤ μ—°κ²°μ€ μ„λΉ„μ¤ λ’·λ‹¨μ λ¨λ“  νλ“λ΅ λ΅λ“λ°Έλ°μ‹±

**λ μ΄λΈ” μ…€λ ‰ν„°**λ΅ νΉμ • νλ“κ°€ μ–΄λ–¤ μ„λΉ„μ¤μ μΌλ¶€μΈμ§€ μ •μν•  μ μλ‹¤!

### μ„λΉ„μ¤ μƒμ„±

λ°©λ²•β‘  `kubectl expose`λ¥Ό μ‚¬μ©ν•μ—¬ μ„λΉ„μ¤ μƒμ„±ν•κ³  λ¨λ“  νλ“λ¥Ό λ‹¨μΌ IP μ£Όμ†μ™€ ν¬νΈλ΅ λ…Έμ¶

λ°©λ²•β‘΅ k8s API μ„λ²„μ— yaml νμΌλ΅ μ„λΉ„μ¤ μ •μ

```yaml
# kubia-svc.yaml
apiVersion: v1
kind: Service
metadata:
name: kubia
spec:
  ports:
    - port: 80 # μ„λΉ„μ¤κ°€ μ‚¬μ©ν•  ν¬νΈ
      targetPort: 8080 # μ„λΉ„μ¤κ°€ ν¬μ›λ“ν•  ν¬νΈ
      selector:
        app: kubia # app=kubia λ μ΄λΈ”μ λ¨λ“  νλ“κ°€ μ΄ μ„λΉ„μ¤μ— ν¬ν•¨
```

```bash
kubectl create -f kubia-svc.yaml
```

### ν΄λ¬μ¤ν„° λ‚΄μ—μ„ μ‹¤ν–‰ μ¤‘μΈ μ»¨ν…μ΄λ„μ— μ›κ²©μΌλ΅ μ„λΉ„μ¤ μ ‘κ·Ό

`kubectl exec` β†’ μ»¨ν…μ΄λ„μ λ‚΄μ©, μƒνƒ, ν™κ²½ κ²€μ‚¬ μ‹μ— μ μ©

```bash
# νλ“μ™€ μ„λΉ„μ¤μ Cluster IP ν™•μΈ
kubectl get po
kubectl get svc

# λ”λΈ”λ€μ‰¬(--) λ’¤μ λ…λ Ήμ€ νλ“ λ‚΄μ—μ„ μ‹¤ν–‰λμ–΄μ•Ό ν•λ” λ…λ Ήμ–΄
kubectl exec {pod_name} --curl -s http://{clusterIP}
```

<img src="https://user-images.githubusercontent.com/70079416/220809982-d1f21857-0620-410e-8845-6bd098c9c573.png" width="50%" height="50%" />

curlμ„ ν™μ©ν• μ„λΉ„μ¤ μ—°κ²° ν…μ¤νΈ λ™μ‘μ›λ¦¬

<aside>
π’« curlμ€ HTTP μ”μ²­μ„ μ„λΉ„μ¤ IPλ΅ μ „λ‹¬
k8sμ μ„λΉ„μ¤ ν”„λ΅μ‹κ°€ μ—°κ²°μ„ κ°€λ΅μ±„μ„ μ„μμ νλ“λ΅ μ”μ²­μ„ μ „λ‹¬
ν•΄λ‹Ή νλ“ λ‚΄μ—μ„ μ‹¤ν–‰ μ¤‘μΈ NodeJSκ°€ μ”μ²­ μ²λ¦¬ ν›„ HTTP μ‘λ‹µ λ°ν™
curlμ€ ν‘μ¤€μ¶λ ¥λ΅ μ‘λ‹µ μ¶λ ¥

</aside>

### μ„λΉ„μ¤μ sessionAffinity

μ΄κ±΄ μ„μμ νλ“μ— μ—°κ²°ν•΄μ„ curlλ΅ μ”μ²­ ν™•μΈν•λ” κ³Όμ • β†’ μ”μ²­ν•  λ•λ§λ‹¤ λ‹¤λ¥Έ νλ“κ°€ μ„ νƒλλ‹¤

β‡’ λ¨λ“  μ”μ²­μ„ λ§¤λ² κ°™μ€ νλ“λ΅ λ¦¬λ””λ ‰μ…ν•λ ¤λ©΄ `sessionAffinity` μ†μ„±μ„ `ClientIP`λ΅ μ„¤μ •ν•λ‹¤!

```yaml
apiVersion: v1
kind: Service
metadata:
  name: kubia
spec:
  sessionAffinity: ClientIP
```

- λ™μΌ μ„λΉ„μ¤λ¥Ό μ—¬λ¬ ν¬νΈλ΅ λ…Έμ¶

  - port nameμ„ μ§€μ •ν•΄μ•Ό ν•λ‹¤.

  ```yaml
  ---
  spec:
  ports:
    - name: http
      port: 80 # μ„λΉ„μ¤κ°€ μ‚¬μ©ν•  ν¬νΈ
      targetPort: 8080 # μ„λΉ„μ¤κ°€ ν¬μ›λ“ν•  ν¬νΈ
    - name: https
      port: 443 # μ„λΉ„μ¤κ°€ μ‚¬μ©ν•  ν¬νΈ
      targetPort: 8443
  selector:
    app: kubia
  ```

- ν¬νΈμ— μ΄λ¦„μ„ μ§€μ •
  ```yaml
  kind: Pod
  spec:
    containers:
      - name: kubia
        ports:
          - name: http
            containerPort: 8080
          - name: https
            containerPort: 8443
  ```
  ```yaml
  apiVersion: v1
  kind: Service
  spec:
    ports:
      - name: http
        port: 80
        targetPort: http
      - name: https
        port: 443
        targetPort: https
  ```
  β‡’ λ‚μ¤‘μ— μ„λΉ„μ¤κ°€ μ•„λ‹ νλ“ μ¤ν™μ„ λ³€κ²½ν•¨μΌλ΅μ¨ ν¬νΈ λ²νΈλ¥Ό λ°”κΏ€ μ μμ

### μ„λΉ„μ¤ κ²€μƒ‰

λ°©λ²•β‘  ν™κ²½λ³€μλ΅ μ„λΉ„μ¤ IP μ£Όμ†μ™€ ν¬νΈ μ •λ³΄ λ“±λ΅

λ°©λ²•β‘΅ DNS μ„λ²„λ¥Ό ν™μ©

- `kube-system` nsμ `kube-dns` νλ“λ” dns μ„λ²„λ¥Ό μ‹¤ν–‰

λ°©λ²•β‘Ά FQDNμ„ ν†µν• μ„λΉ„μ¤ μ—°κ²°

λ°©λ²•β‘£ νλ“ μ»¨ν…μ΄λ„ λ‚΄μ—μ„ `kubectl exec` λ…λ Ήμ–΄λ΅ bashμ™€ κ°™μ€ shell μ‹¤ν–‰

---

## 5.2 ν΄λ¬μ¤ν„° μ™Έλ¶€μ— μλ” μ„λΉ„μ¤ μ—°κ²°

### β‘  νλ“ μ…€λ ‰ν„°λ΅ μ„λΉ„μ¤ μ—”λ“ν¬μΈνΈ λ¦¬μ†μ¤ μƒμ„±

```bash
# service endpoint ν™•μΈ
kubectl describe svc {svc_name}
```

- `Selector`: νλ“ μ…€λ ‰ν„°λ” μ—”λ“ν¬μΈνΈ λ©λ΅μ„ μƒμ„±ν•λ” λ° μ‚¬μ©
  - μ„λΉ„μ¤ μ •μ μ‹, νλ“ μ…€λ ‰ν„°λ¥Ό μ •μν•μ§€ μ•μΌλ©΄ μ—”λ“ν¬μΈνΈ λ¦¬μ†μ¤κ°€ μλ™μƒμ„±λμ§€ μ•λ”λ‹¤
- `Endpoints`: ν•΄λ‹Ή μ„λΉ„μ¤μ μ—”λ“ν¬μΈνΈλ¥Ό λ‚νƒ€λ‚΄λ” νλ“ IPμ™€ ν¬νΈ λ©λ΅
  ```bash
  # endpoint μ •λ³΄λ§ μ¶λ ¥
  kubectl get endpoints {svc_name}
  ```

### β‘΅ μλ™μΌλ΅ μ—”λ“ν¬μΈνΈ κµ¬μ„±

```yaml
apiVersion: v1
kind: Endpoints
metadata:
name: { svc_name }
subsets:
  - addresses:
      - ip: 11.11.11.11
      - ip: 22.22.22.22
    ports:
      - port: 80
```

- μ—”λ“ν¬μΈνΈμ μ¤λΈμ νΈλ…μ€ μ„λΉ„μ¤λ…κ³Ό μΌμΉν•΄μ•Ό ν•λ‹¤.
- μ„λΉ„μ¤μ™€ μ—”λ“ν¬μΈνΈ λ¨λ‘ μ„λ²„μ— κ²μ‹ν•λ©΄ μΌλ° μ„λΉ„μ¤μ²λΌ μ‚¬μ© κ°€λ¥ β†’ μλ™ λ°°ν¬ μ™„λ£!
- μ—”λ“ν¬μΈνΈ yamlμ— μ •μλμ–΄ μλ” IPμ£Όμ†μ™€ ν¬νΈ μμ— λ€ν• λ¨λ“  μ—°κ²°μ€ μ„λΉ„μ¤ μ—”λ“ν¬μΈνΈ κ°„μ— λ΅λ“λ°Έλ°μ‹±

<img src="https://user-images.githubusercontent.com/70079416/220809963-7c281cbe-54e8-4927-b551-b1c2d7ebc03e.png" width="50%" height="50%" />

### β‘Ά ExternalName μ„λΉ„μ¤ μƒμ„±

μ„λΉ„μ¤μ μ—”λ“ν¬μΈνΈλ¥Ό μλ™μΌλ΅ κµ¬μ„±ν•λ” λ‘λ²μ§Έ λ°©λ²•λ³΄λ‹¤ FQDN(Fully Qualified Domain Name)μΌλ΅ μ™Έλ¶€ μ„λΉ„μ¤ μ°Έμ΅°ν•λ” λ°©μ‹μ΄ λ” κ°„λ‹¨

- DNS λ λ²¨μ—μ„λ§ κµ¬ν„λκ³ , ν΄λΌμ΄μ–ΈνΈλ” μ„λΉ„μ¤ ν”„λ΅μ‹λ¥Ό μ™„μ „ν λ¬΄μ‹ν•κ³  μ™Έλ¶€ μ„λΉ„μ¤μ— μ§μ ‘ μ—°κ²°λλ―€λ΅ ExternalName μ ν•μ μ„λΉ„μ¤λ” Cluster IPλ¥Ό μ–»μ§€ λ»ν•λ‹¤.

---

## 5.3 μ™Έλ¶€ ν΄λΌμ΄μ–ΈνΈμ— μ„λΉ„μ¤ λ…Έμ¶

<aside>
π’« λ°©λ²•β‘  NodePort
λ°©λ²•β‘΅ LoadBalaner
λ°©λ²•β‘Ά Ingress

</aside>

### NodePort μ„λΉ„μ¤

λ¨λ“  λ…Έλ“μ— νΉμ • ν¬νΈλ¥Ό ν• λ‹Ή

```yaml
apiVersion: v1
kind: Service
metadata:
  name: kubia-nodeport
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: 8080
      nodePort: 30123
  selector:
    app: kubia
```

- minikube μ‚¬μ© μ‹
  ```bash
  minikube service {svc_name} -n {ns_name}
  ```
- GKE μ‚¬μ© μ‹ μ™Έλ¶€μ—μ„ λ…Έλ“ν¬νΈ μ„λΉ„μ¤μ— μ ‘κ·Όν•  μ μλ„λ΅ λ°©ν™”λ²½ κ·μΉ™ λ³€κ²½
  ```bash
  gcloud compute firewall-rules create {svc-rule_name} --allow=tcp:{nodeport_port}
  ```

### LoadBalancer μ„λΉ„μ¤

ν΄λΌμ΄μ–ΈνΈκ°€ μ”μ²­μ„ λ³΄λ‚΄λ” λ…Έλ“μ— μ¥μ• κ°€ λ‚λ©΄ λ” μ΄μƒ μ„λΉ„μ¤μ— μ ‘κ·Όν•  μ μ—†λ‹¤

β‡’ λ¨λ“  λ…Έλ“μ— μ”μ²­μ„ λ¶„μ‚°μ‹ν‚¤κ³  μ¤ν”„λΌμΈ μƒνƒμ λ…Έλ“μ—λ” μ”μ²­μ„ λ³΄λ‚΄μ§€ μ•λ„λ΅ ν•λ” λ΅λ“λ°Έλ°μ„ λ°°μΉ

<aside>
β€ΌοΈ minikubeλ” LoadBalancer νƒ€μ…μ„ μ§€μ›ν•μ§€ μ•λ”λ‹¤

</aside>

```yaml
# svc-loadbalancer.yaml
apiVersion: v1
kind: Service
metadata:
  name: kubia-loadbalancer
spec:
  type: LoadBalancer
  ports:
    - port: 80
    targetPort: 8080
  selector:
    app: kubia
```

```bash
kubectl create -f svc-loadbalancer.yaml
```

β‡’ λ°°ν¬ μ™„λ£ μ‹ external IPκ°€ ν• λ‹Ήλκ³  curl ν†µμ‹ μΌλ΅ μ„λΉ„μ¤μ— μ•΅μ„Έμ¤ν•  μ μλ‹¤. (λ°©ν™”λ²½ μ„¤μ •λ„ λ”°λ΅ ν•„μ” X)

<img src="https://user-images.githubusercontent.com/70079416/220809968-9c258b42-7fa6-4a58-9ca1-4f7337cc5a1b.png" width="50%" height="50%" />

nodeport

<img src="https://user-images.githubusercontent.com/70079416/220809970-ee587373-2127-4fdf-9ad2-7a16d6b3605b.png" width="50%" height="50%" />

load balancer

---

## 5.4 μΈκ·Έλ μ¤ λ¦¬μ†μ¤

[μΈκ·Έλ μ¤(Ingress)](https://kubernetes.io/ko/docs/concepts/services-networking/ingress/)λ” ν΄λ¬μ¤ν„° μ™Έλ¶€μ—μ„ ν΄λ¬μ¤ν„° λ‚΄λ¶€Β μ„λΉ„μ¤λ΅ HTTPμ™€ HTTPS κ²½λ΅λ¥Ό λ…Έμ¶ν•λ‹¤. νΈλν”½ λΌμ°ν…μ€ μΈκ·Έλ μ¤ λ¦¬μ†μ¤μ— μ •μλ κ·μΉ™μ— μν•΄ μ»¨νΈλ΅¤λλ‹¤.

<img src="https://user-images.githubusercontent.com/70079416/220809974-0269362c-7724-49f8-8986-06757d7cce8f.png" width="50%" height="50%" />

> μΈκ·Έλ μ¤λ” ν• IP μ£Όμ†λ΅ μ—¬λ¬ μ„λΉ„μ¤μ— μ ‘κ·Όμ΄ κ°€λ¥ν•λ‹¤.
> ν΄λΌμ΄μ–ΈνΈκ°€ μΈκ·Έλ μ¤μ— HTTP μ”μ²­μ„ λ³΄λ‚Ό λ•, μ”μ²­ν• νΈμ¤νΈμ™€ κ²½λ΅μ— λ”°λΌ μ”μ²­μ„ μ „λ‹¬ν•  μ„λΉ„μ¤ κ²°μ •λ¨

<img src="https://user-images.githubusercontent.com/70079416/220809976-ce31afe2-7daf-4a67-800e-3af5034b8589.png" width="50%" height="50%" />

νλ“ μ…€λ ‰ν„°μ™€ μ„λΉ„μ¤μ λ μ΄λΈ” μ…€λ ‰ν„°κ°€ λ™μΌν•λ©΄ ν•΄λ‹Ή μ„λΉ„μ¤μ μ—”λ“ν¬μΈνΈλ΅ νλ“κ°€ ν¬ν•¨λλ‹¤.

<aside>
π’¬ minikubeλ” κΈ°λ³Έ μΈκ·Έλ μ¤ μ»¨νΈλ΅¤λ¬ μ κ³µ X, μΈκ·Έλ μ¤ κΈ°λ¥μ„ μ‹ν—ν•΄λ³Ό μ μλ” μ• λ“μ¨ μ κ³µ O

</aside>

```bash
# μ• λ“μ¨ list ν™•μΈν•μ—¬ ingress: disabled μ²΄ν¬ν•κ³  ingress ν™μ„±ν™”
minikube addons list
minikube addons enable ingress
```

### μΈκ·Έλ μ¤ μƒμ„±

```yaml
# kubia-ingress.yaml
apiVersion: extensions/v1
kind: Ingress
metadata:
  name: kubia
spec:
  rules:
    - host: kubia.example.com
      http:
      paths:
        - path: /
          backend:
            serviceName: kubia-nodeport
            servicePort: 80
```

`kubia.example.com` hostλ΅ μ”μ²­λλ” μΈκ·Έλ μ¤ μ»¨νΈλ΅¤λ¬μ— μμ‹ λ λ¨λ“  HTTP μ”μ²­μ„ 80λ² ν¬νΈμ kubia-nodeport μ„λΉ„μ¤λ΅ μ „μ†΅ν•λ” μΈκ·Έλ μ¤ κ·μΉ™ μ •μ

### μΈκ·Έλ μ¤λ΅ μ„λΉ„μ¤ μ•΅μ„Έμ¤

1. λ„λ©”μΈ μ΄λ¦„μ΄ μΈκ·Έλ μ¤ μ»¨νΈλ΅¤λ¬μ IPμ™€ λ§¤ν•‘λλ„λ΅ ν™•μΈ

```bash
kubectl get ingresses
# ADDRESSμ—μ„ IP ν™•μΈ κ°€λ¥
```

1. λ„λ©”μΈμ΄ ν•΄λ‹Ή IPλ΅ ν™•μΈν•λ„λ΅ DNS μ„λ²„ κµ¬μ„±ν•κ±°λ‚ /etc/hostsμ— IPμ™€ λ„λ©”μΈ μ¶”κ°€

```bash
{ip_addr}    {domain_name}
# 192.xx.xx.xx   kubia.example.com
```

curl λ…λ Ήμ–΄λ΅ μ•΅μ„Έμ¤

```yaml
curl http://{domain_name}
```

### μΈκ·Έλ μ¤ λ™μ‘

μΈκ·Έλ μ¤ μ»¨νΈλ΅¤λ¬λ” μ”μ²­μ„ μ„λΉ„μ¤λ΅ μ „λ‹¬ν•μ§€ μ•κ³  νλ“λ¥Ό μ„ νƒν•λ” λ°μ—λ§ μ‚¬μ©ν•λ‹¤.

### ν•λ‚μ μΈκ·Έλ μ¤λ΅ μ—¬λ¬ μ„λΉ„μ¤ λ…Έμ¶

βΆ λ™μΌ νΈμ¤νΈμ λ‹¤λ¥Έ κ²½λ΅λ΅ μ—¬λ¬ μ„λΉ„μ¤ λ§¤ν•‘

`.spec.rules[].http.paths`μ— `path`, `backend`κ°’ μ¶”κ°€

- example
  ```yaml

  ---
  spec:
    rules:
      - host: kubia.example.com
        http:
        paths:
          - path: /kubia
            backend:
              serviceName: kubia
              servicePort: 80
          - path: /foo
            backend:
              serviceName: foo
              servicePort: 80
  ```

βΆ μ„λ΅ λ‹¤λ¥Έ νΈμ¤νΈλ΅ μ„λ΅ λ‹¤λ¥Έ μ„λΉ„μ¤ λ§¤ν•‘

`.spec.rules[].host` μ¶”κ°€

- example
  ```yaml
  ...
  spec:
    rules:
    - host: foo.example.com
      http:
        paths:
        - path: /
          backend:
            serviceName: foo
            servicePort: 80
        - host:
          http:
            paths: bar.example.com
            - path: /
              backend:
                serviceName: bar
                servicePort: 80
  ```
  - νΈμ¤νΈ headerμ— λ”°λΌ fooλ‚ barλ΅ μ”μ²­ μ „λ‹¬
  - DNSλ” λ‘ λ„λ©”μΈ μ΄λ¦„μ„ λ¨λ‘ μΈκ·Έλ μ¤ μ»¨νΈλ΅¤λ¬μ IP μ£Όμ†λ΅ μ§€μ •ν•΄μ•Ό ν•λ‹¤.

### TLS νΈλν”½ μ²λ¦¬

ν΄λΌμ΄μ–ΈνΈ - μ»¨νΈλ΅¤λ¬ κ°„ ν†µμ‹  μ•”νΈν™” OK, μ»¨νΈλ΅¤λ¬ - λ°±μ—”λ“ νλ“ κ°„ ν†µμ‹ μ€ μ•”νΈν™” X

β‡’ μ»¨νΈλ΅¤λ¬κ°€ TLS νΈλν”½μ„ μ²λ¦¬ν•λ„λ΅ κ°μΈν‚¤μ™€ μΈμ¦μ„λ¥Ό μ‹ν¬λ¦ΏμΌλ΅ μ •μν•μ—¬ μΈκ·Έλ μ¤μ— μ²¨λ¶€

```bash
openssl genrsa -out tls.key 2048
openssl req -new -x509 -key tls.key -out tls.cert -days 360 -subj

kubectl create secret tls tls-secret --cert=tls.cert --key=tls.key
# kubectl create secret tls {secret_name} --cert={cert_name} --key={key_name}
```

```yaml
# kubia-ingress-tls.yaml
apiVersion: extensions/v1
kind: Ingress
metadata:
  name: kubia
spec:
  tls:
    - hosts:
        - kubia.example.com
      secretName: tls-secret
  rules:
    - host: kubia.example.com
      http:
        paths:
          - path: /
            backend:
              serviceName: kubia-nodeport
              servicePort: 80
```

---

## 5.5 λ λ””λ‹μ¤ ν”„λ΅λΈ

> _μ£ΌκΈ°μ μΌλ΅ νΈμ¶λλ©° νΉμ • νλ“κ°€ ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ„ μμ‹ ν•  μ μλ”μ§€ κ²°μ •_

- μ„Έ κ°€μ§€ λ©”μ»¤λ‹μ¦
  - Exec ν”„λ΅λΈ: μ»¨ν…μ΄λ„ μƒνƒλ¥Ό ν”„λ΅μ„Έμ¤μ μΆ…λ£ μƒνƒ μ½”λ“λ΅ κ²°μ •
  - HTTP GET ν”„λ΅λΈ: GET μ”μ²­μ„ μ»¨ν…μ΄λ„λ΅ λ³΄λ‚΄κ³  μ‘λ‹µμ HTTP μƒνƒ μ½”λ“μ— λ”°λΌ μ»¨ν…μ΄λ„μ μ¤€λΉ„ μ—¬λ¶€ κ²°μ •
  - TCP μ†μΌ“ ν”„λ΅λΈ: μ»¨ν…μ΄λ„μ μ§€μ •λ ν¬νΈλ΅ TCP μ—°κ²°μ„ μ—΄κ³  μ—°κ²°λλ©΄ μ»¨ν…μ΄λ„ μ¤€λΉ„ μ™„λ£λ΅ κ°„μ£Ό

### λ λ””λ‹μ¤ ν”„λ΅λΈ λ™μ‘

| λΌμ΄λΈλ‹μ¤ ν”„λ΅λΈ                                                                          | λ λ””λ‹μ¤ ν”„λ΅λΈ                                                            |
| ------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------- |
| k8sμ health checkλ¥Ό ν†µν•΄ μ •μƒμ μ΄μ§€ λ»ν•λ©΄ μ»¨ν…μ΄λ„λ¥Ό μ¬μ‹μ‘                              | μ»¨ν…μ΄λ„κ°€ μ¤€λΉ„ μƒνƒ μ κ²€μ— μ‹¤ν¨ν•΄λ„ μ»¨ν…μ΄λ„κ°€ μΆ…λ£λκ±°λ‚ μ¬μ‹μ‘ν•μ§€ μ•μ |
| health checkμ— μ‹¤ν¨ν• μ»¨ν…μ΄λ„λ¥Ό μ κ±°ν•κ³  μƒλ΅μ΄ μ»¨ν…μ΄λ„λ΅ κµμ²΄ β‡’ νλ“ μƒνƒ μ •μƒμΌλ΅ μ μ§€ | μ”μ²­μ„ μ²λ¦¬ν•  μ¤€λΉ„κ°€ λ νλ“μ μ»¨ν…μ΄λ„λ§ μ”μ²­μ„ μμ‹ ν•λ„λ΅ ν•¨             |

<img src="https://user-images.githubusercontent.com/70079416/220809979-3c5f6c26-b5c0-4573-883b-01a96cce1514.png" width="50%" height="50%" />

- λ λ””λ‹μ¤ ν”„λ΅λΈ μ‹¤ν¨ μ‹, νλ“λ” μ—”λ“ν¬μΈνΈ μ¤λΈμ νΈμ—μ„ μ κ±°
- μ„λΉ„μ¤λ΅ μ—°κ²°ν•λ” ν΄λΌμ΄μ–ΈνΈμ μ”μ²­μ€ νλ“λ΅ μ „λ‹¬λμ§€ μ•λ”λ‹¤.

#### λ λ””λ‹μ¤ ν”„λ΅λΈκ°€ μ¤‘μ”ν• μ΄μ ?

ν΄λΌμ΄μ–ΈνΈκ°€ μ •μƒμ μΈ νλ“μ™€ ν†µμ‹ ν•κ³  μ‹μ¤ν…μ— λ¬Έμ κ°€ μλ‹¤λ” κ²ƒμ„ μ λ€ μ•μ•„μ°¨λ¦¬μ§€ λ»ν•λ‹¤!

### λ λ””λ‹μ¤ ν”„λ΅λΈ μ •μ

- `.spec.template.spec.containers`μ μ²« λ²μ§Έ μ»¨ν…μ΄λ„μ— μ¶”κ°€
- νλ“λ” λ λ””λ‹μ¤ μ κ²€μ— μ„±κ³µν•  λ•κΉμ§€ μ„λΉ„μ¤μ μ—”λ“ν¬μΈνΈμ— ν¬ν•¨λμ§€ μ•μ

### μ‹¤μ  ν™κ²½μ—μ„ λ λ””λ‹μ¤ ν”„λ΅λΈκ°€ μν–‰ν•λ” κΈ°λ¥

- μ• ν”λ¦¬μΌ€μ΄μ…μ΄ ν΄λΌμ΄μ–ΈνΈ μ”μ²­μ„ μμ‹ ν•  μ μλ”μ§€ μ—¬λ¶€μ— λ”°λΌ μ„±κ³µ/μ‹¤ν¨ λ°ν™
- μ„λΉ„μ¤μ—μ„ νλ“λ¥Ό μλ™μΌλ΅ μ¶”κ°€ or μ κ±°ν•λ ¤λ©΄ νλ“μ™€ μ„λΉ„μ¤μ λ μ΄λΈ” μ…€λ ‰ν„°μ— `enabled=true` λ μ΄λΈ”μ„ μ¶”κ°€ or μ κ±°ν•λ‹¤.
- λ λ””λ‹μ¤ ν”„λ΅λΈλ¥Ό ν•­μƒ μ •μν•λΌ
  - λ λ””λ‹μ¤ ν”„λ΅λΈκ°€ μ—†μΌλ©΄ νλ“λ” μ‹μ‘ν•λ” μ¦‰μ‹ μ„λΉ„μ¤ μ—”λ“ν¬μΈνΈκ°€ λλ‹¤.
  - ν΄λΌμ΄μ–ΈνΈμ μ„λΉ„μ¤ μ”μ²­μ€ μ—¬μ „ν μ‹μ‘ λ‹¨κ³„λ΅ μ¤€λΉ„λμ§€ μ•μ€ νλ“λ΅ μ „λ‹¬λ  μ μκ³ , ν΄λΌμ΄μ–ΈνΈλ” `Connection refused` μ ν•μ μ—λ¬λ¥Ό λ§μ£Όν•  μ μλ‹¤.
- νλ“μ μΆ…λ£μ½”λ“λ¥Ό ν¬ν•¨ν•μ§€ λ§λΌ
  - μΏ λ²„λ„¤ν‹°μ¤λ” νλ“λ¥Ό μ‚­μ ν•μλ§μ λ¨λ“  μ„λΉ„μ¤μ—μ„ νλ“λ¥Ό μ κ±°ν•λ―€λ΅ μΆ…λ£ μ μ°¨μ— λ€ν• λ λ””λ‹μ¤ ν”„λ΅λΈλ” λ¶ν•„μ”ν•λ‹¤.

---

## 5.6 ν—¤λ“λ¦¬μ¤ μ„λΉ„μ¤λ΅ κ°λ³„ νλ“ μ°ΎκΈ°

> μ„λΉ„μ¤ μ—°κ²°μ€ μ„μμ νλ“λ΅ μ „λ‹¬
> κ·Έλ°λ° ν΄λΌμ΄μ–ΈνΈκ°€ **λ¨λ“  νλ“μ— μ—°κ²°**ν•΄μ•Ό ν•λ” κ²½μ°? **_DNS μ΅°νλ¥Ό μν–‰ν•λ©΄ κ° νλ“μ IP μ£Όμ†λ¥Ό λ°ν™_**

DNS μ΅°ν β†’ ν•λ‚μ IP λ°ν™

κ·Όλ° cluster IPλ¥Ό `None`μΌλ΅ μ„¤μ •ν•λ©΄ ν•λ‚μ μ„λΉ„μ¤ IP λ€μ‹  **λ¨λ“  νλ“ IPλ¥Ό λ°ν™!**

**β‡’ μ„λΉ„μ¤λ¥Ό ν—¤λ“λ¦¬μ¤ μƒνƒλ΅ μ •μν•λ” κ²ƒ**

```yaml
# kubia-headless.yaml
apiVersion: v1
kind: Service
...
spec:
  clusterIP: None
  ports:
	...
```

### DNS μ΅°ν

; μ‹¤ν–‰ μ¤‘μΈ νλ“ λ‚΄λ¶€μ—μ„ μν–‰

1. `tutum/dnsutils` μ»¨ν…μ΄λ„ μ΄λ―Έμ§€λ¥Ό κΈ°λ°μΌλ΅ μƒ νλ“ μ‹¤ν–‰

   1. λ³„λ„μ yaml νμΌ μ—†μ΄ μ•„λ λ…λ Ήμ–΄λ΅ νλ“ μ‹¤ν–‰

   ```bash
   kubectl run dnsutils --image=tutum/dnsutils --generator=run-pod/v1
   ```

2. DNS μ΅°ν

   ```bash
   # service_name: μ•μ„ λ°°ν¬ν–λ μ„λΉ„μ¤ yamlμ— μ •μλμ–΄ μλ” name
   kubectl exec dnsutils nslookup {service_name}
   ```

### β€λ¨λ“ β€™ νλ“ κ²€μƒ‰

μ¤€λΉ„λ νλ“λ§ μ„λΉ„μ¤ μ—”λ“ν¬μΈνΈκ°€ λλ”λ° μ¤€λΉ„λμ§€ μ•μ€ νλ“κΉμ§€ κ²€μƒ‰ν•λ ¤λ©΄?

β‡’ `publishNotReadyAddresses` annotationμ„ μ¶”κ°€ν•λ‹¤.

```yaml

---
kind: Service
metadata:
  annotations:
    publishNotReadyAddresses: "true"
```

---

## 5.7 μ„λΉ„μ¤ λ¬Έμ  ν•΄κ²°

KIA 257p. β‡’ λ€λ¶€λ¶„μ μ„λΉ„μ¤ κ΄€λ ¨ μ΄μλ¥Ό ν•΄κ²°ν•  μ μλ” λ°©λ²• μ μ‹λμ–΄ μμ
